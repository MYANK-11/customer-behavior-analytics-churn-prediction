SELECT * FROM customer_data;

--Q1. WHAT IS THE TOTAL REVENUE GENERATED BY MALE VS FEMALE CUSTOMERS ?
SELECT gender, SUM(purchase_amount) AS REVENUE FROM customer_data GROUP BY gender;

--Q2. WHICH CUSTOMER USED A DISCOUNT BUT STILL SPENT MORE THAN THE AVERAGE PURCHASE AMOUNT ?
SELECT customer_id, purchase_amount 
FROM customer_data 
WHERE discount_applied='Yes' AND purchase_amount >=(SELECT AVG(purchase_amount) as AVGERAGE_PURCHASE_AMOUNT FROM customer_data);

--Q3.WHICH ARE THE TOP 5 PRODUCTS WITH THE HIGHEST AVERAGE REVIEW RATING ?
SELECT item_purchased , ROUND(AVG(review_rating::numeric),2) as average_rr
FROM customer_data
GROUP BY item_purchased
ORDER BY AVG(review_rating) DESC
LIMIT 5;

--Q4.COMPARE THE AVERAGE PURCHASE AMOUNTS BETWEEN STANDARD AND EXPRESS SHIPPING ?

SELECT shipping_type, ROUND(AVG(purchase_amount),2) 
FROM customer_data
WHERE shipping_type IN ('Express', 'Standard')
GROUP BY shipping_type
ORDER BY AVG(purchase_amount);


--Q5.DO SUBCRIBED CUSTOMER SPEND MORE ? COMPARE AVERAGE SPEND AND TOTAL REVENUE BETWEEN SUBCRIBERS AND NON- SUBCRIBERS.

SELECT ROUND(AVG(purchase_amount),2) AS AVG_SPEND , ROUND(SUM(purchase_amount),2) AS REVENUE , subscription_status , COUNT(customer_id) as Total_Customer
FROM customer_data
WHERE subscription_status IN ('Yes','No')
GROUP BY subscription_status
ORDER BY AVG_SPEND DESC, REVENUE ;


--Q6. WHICH 5 PRODUCTS HAVE THE HIGHEST PERCENTAGE OF PURCHASE WITH DISCOUNT APPLIED ?

SELECT item_purchased,
ROUND(100* SUM(CASE WHEN discount_applied = 'Yes' THEN 1 ELSE 0 END)/COUNT(*),2) AS discount_rate
FROM customer_data
GROUP BY item_purchased
ORDER BY discount_rate DESC
LIMIT 5;

-- Q7.SEGMENT CUSTOMER INTO NEW , RETURNING , AND LOYAL BASED ON THEIR TOTAL NUMBER OF THE PREVIOUS PURCHASES , AND SHOW THE COUNT OF EACH SEGMENT.
WITH  customer_type AS (
SELECT customer_id, previous_purchases,
CASE 
    WHEN previous_purchases=1 THEN 'New'
	WHEN previous_purchases BETWEEN 2 AND 10 THEN 'Returning'
	ELSE 'Loyal'
	END AS customer_segment 
FROM customer_data
)

SELECT customer_segment , COUNT(*) AS "Number of Customers"
FROM customer_type
GROUP BY customer_segment;


-- Q8. WHAT ARE THE TOP 3 MOST PURCHASED PRODUCTS WITHIN EACH CATEGORY ?
SELECT *
FROM (
    SELECT 
        category,
        item_purchased,
        COUNT(*) AS total_purchases,
        ROW_NUMBER() OVER (
            PARTITION BY category
            ORDER BY COUNT(*) DESC
        ) AS rn
    FROM customer_data
    GROUP BY category, item_purchased
) t
WHERE rn <= 3;


--Q9. ARE CUSTOMERS WHO ARE REPEAT BUYERS (MORE THAN 5 PREVIOUS PURCHASES) ALSO LIKELY TO SUBCRIBE?

SELECT subscription_status, COUNT(customer_id) AS REPEAT_BUYERS 
FROM customer_data 
WHERE previous_purchases > 5 
GROUP BY subscription_status;


--Q10. WHAT IS THE REVENUE CONTRIBUTION OF EACH AGE GROUP ?
SELECT age_group , SUM(purchase_amount) AS REVENUE FROM customer_data GROUP BY age_group ORDER BY REVENUE DESC;



-- Q11.How does average purchase amount and total revenue vary across different purchase frequency segments?
SELECT
    CASE
        WHEN purchase_frequency_days < 7 THEN '0–7 days (very frequent)'
        WHEN purchase_frequency_days BETWEEN 7 AND 30 THEN '7–30 days (frequent)'
        WHEN purchase_frequency_days BETWEEN 31 AND 90 THEN '31–90 days (occasional)'
        ELSE '> 90 days (rare)'
    END AS purchase_speed_segment,
    COUNT(*) AS total_orders,
    SUM(purchase_amount) AS total_revenue,
    AVG(purchase_amount) AS avg_purchase_amount
FROM customer_data
GROUP BY
    CASE
        WHEN purchase_frequency_days < 7 THEN '0–7 days (very frequent)'
        WHEN purchase_frequency_days BETWEEN 7 AND 30 THEN '7–30 days (frequent)'
        WHEN purchase_frequency_days BETWEEN 31 AND 90 THEN '31–90 days (occasional)'
        ELSE '> 90 days (rare)'
    END
ORDER BY total_revenue DESC;



-- Q12. How does average purchase amount and total revenue differ across customers with different levels of previous purchase history?

SELECT 
    CASE 
        WHEN previous_purchases = 0 OR previous_purchases IS NULL THEN 'NO HISTORY (0)'
        WHEN previous_purchases BETWEEN 1 AND 15 THEN 'LOW HISTORY (1–15)'
        WHEN previous_purchases BETWEEN 16 AND 32 THEN 'MEDIUM HISTORY (16–32)'
        ELSE 'HIGH HISTORY (>32)'
    END AS previous_purchases_history_segment,
    COUNT(DISTINCT customer_id) AS customer_count,
    COUNT(*) AS total_orders,
    AVG(purchase_amount) AS avg_purchase_amount,
    SUM(purchase_amount) AS total_revenue
FROM customer_data
GROUP BY 
    CASE 
        WHEN previous_purchases = 0 OR previous_purchases IS NULL THEN 'NO HISTORY (0)'
        WHEN previous_purchases BETWEEN 1 AND 15 THEN 'LOW HISTORY (1–15)'
        WHEN previous_purchases BETWEEN 16 AND 32 THEN 'MEDIUM HISTORY (16–32)'
        ELSE 'HIGH HISTORY (>32)'
    END
ORDER BY total_revenue DESC;


-- Q13. What is the relationship between average purchase frequency (in days) and purchase amount?
SELECT 
    CASE 
        WHEN purchase_frequency_days BETWEEN 0 AND 7 THEN 'Very Frequent (0–7 days)'
        WHEN purchase_frequency_days BETWEEN 8 AND 30 THEN 'Frequent (8–30 days)'
        WHEN purchase_frequency_days BETWEEN 31 AND 90 THEN 'Occasional (31–90 days)'
        WHEN purchase_frequency_days > 90 THEN 'Rare (>90 days)'
        ELSE 'Unknown'
    END AS purchase_frequency_segment,
    COUNT(DISTINCT customer_id) AS customer_count,
    COUNT(*) AS total_orders,
    AVG(purchase_frequency_days) AS avg_purchase_frequency_days,
    AVG(purchase_amount) AS avg_purchase_amount,
    SUM(purchase_amount) AS total_revenue
FROM customer_data
GROUP BY
    CASE 
        WHEN purchase_frequency_days BETWEEN 0 AND 7 THEN 'Very Frequent (0–7 days)'
        WHEN purchase_frequency_days BETWEEN 8 AND 30 THEN 'Frequent (8–30 days)'
        WHEN purchase_frequency_days BETWEEN 31 AND 90 THEN 'Occasional (31–90 days)'
        WHEN purchase_frequency_days > 90 THEN 'Rare (>90 days)'
        ELSE 'Unknown'
    END
ORDER BY purchase_frequency_segment;


-- Q14. How does purchasing behavior differ between customers who frequently receive discounts and those who do not, in terms of average purchase amount, total revenue, and purchase frequency?

SELECT discount_applied, COUNT(*) AS TOTAL_ORDERS, AVG(purchase_amount) AS  avg_purchase_amount , AVG(purchase_frequency_days) AS avg_purchase_frequency_days , SUM(purchase_amount) AS Total_Revenue
FROM customer_data
GROUP BY discount_applied 
ORDER BY total_revenue DESC;


-- Q15. Which customers are at high risk of churn based on having high previous purchases but long gaps between purchases?

SELECT 
    customer_id,
    MAX(previous_purchases) AS total_previous_purchases,
    AVG(purchase_frequency_days) AS avg_purchase_frequency_days,
    SUM(purchase_amount) AS total_revenue
FROM customer_data
WHERE previous_purchases >= 5
GROUP BY customer_id
HAVING AVG(purchase_frequency_days) > 45
ORDER BY total_revenue DESC;

